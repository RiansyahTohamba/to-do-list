image: python:3.7

deployment:
    stage: deploy
    before_script:
        - wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -
        - echo "deb http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google.list
        - apt-get update -qq && apt-get install -y -qq unzip
        - apt-get install -y google-chrome-stable
        - apt-get install -y xvfb
        - wget https://chromedriver.storage.googleapis.com/77.0.3865.40/chromedriver_linux64.zip
        - unzip chromedriver_linux64.zip
        - pip install Django
        - pip install django-environ
        - apt-get update -qy
        - apt-get install -y ruby-dev
        - gem install dpl
        - wget -qO- https://cli-assets.heroku.com/install-ubuntu.sh | sh
    when: on_success
    allow_failure: false
    script:
        - dpl --provider=heroku --app=$HEROKU_NAME --api-key=$HEROKU_API_KEY_STAGING
        - export HEROKU_API_KEY=$HEROKU_API_KEY_STAGING
        - heroku run --app $HEROKU_NAME migrate &
        - python manage.py test functional_test.new_visitor_test
    environment:
        name: heroku
        url: $HEROKU_HOST
